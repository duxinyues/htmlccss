<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>canvas数据可视化</title>
    <style>
        *{margin: 0;padding: 0;}
        canvas {display:block;}
        #canvas{border: 1px solid #bbb;margin: 100px auto}
    </style>
</head>
<body>
    <canvas id="canvas" width="600" height="400"></canvas>
    <script>
        var canvas = document.querySelector("#canvas");
        var ctx = canvas.getContext('2d');
        //定义一个画布对象
        var PieChart = function(ctx){
            this.ctx = ctx || document.querySelector('#canvas').getContext("2d");
            this.w = this.ctx.canvas.width;
            this.h = this.ctx.canvas.height;
            //圆心
            this.x0 = this.w/2 + 60;
            this.y0 = this.h/2;
            this.radius = 150;
            this.outline = 20;
            this.rectW = 30;
            this.rectH = 16;
            this.space = 10;

        }
        //数据初始化
        PieChart.prototype.init = function(data){
            this.drawCir(data)
        }
        //绘制扇形图
        PieChart.prototype.drawCir = function(data){
            var that = this;
            //弧度计算
            var angleList = that.transformAngle(data);
            var startAngle = 0;
            angleList.forEach((item,i) => {
                var endAngle = startAngle + item.angle;
                ctx.beginPath();
                ctx.moveTo(that.x0,that.y0);
                ctx.arc(that.x0,that.y0,that.radius,startAngle,endAngle);
                var color = ctx.fillStyle = that.getRandomColor();
                ctx.fill();
                that.drawLine(startAngle,item.angle,color,item.title);
                that.drawDesc(i,item.title);
                startAngle = endAngle;
            });
        }

        //绘制线条
        PieChart.prototype.drawLine = function(startAngle,angle,color,title){
            var edge = this.radius+this.outline;
            var edgeX = edge*Math.cos(startAngle+angle/2);
            var edgeY = edge*Math.sin(startAngle+angle/2);
            var outX = this.x0+edgeX;
            var outY = this.y0+edgeY;
            this.ctx.beginPath();
            this.ctx.moveTo(this.x0,this.y0);
            this.ctx.lineTo(outX,outY);
            this.ctx.strokeStyle = color;
            this.ctx.font = '14px SimHei';
            var txtWidth = this.ctx.measureText(title).width;
            if(outX > this.x0){
                this.ctx.lineTo(outX+txtWidth,outY);
                this.ctx.textAlign = 'left';
            }else{
                this.ctx.lineTo(outX-txtWidth,outY);
                this.ctx.textAlign = 'right';
            }
            this.ctx.textBaseline = 'bottom';
            this.ctx.fillText(title,outX,outY);
            this.ctx.stroke();

        }

        PieChart.prototype.drawDesc = function(index,title){
            this.ctx.fillRect(this.space,this.space+index*(this.rectH+this.space),this.rectW,this.rectH);
            this.ctx.beginPath();
            this.ctx.textAlign = 'left';
            this.ctx.textBaseline = 'top';
            ctx.font='12px SimHei';
            this.ctx.fillText(title,this.space+this.rectW+10,this.space+index*(this.rectH+this.space));
        };

        //弧度转换
        PieChart.prototype.transformAngle = function(data){
            var tatol = 0;
            data.forEach(function(item,i){
                tatol += item.num;
            })
            console.log(tatol)
            data.forEach(function(item,i){
                var angle = item.num/tatol * Math.PI*2;
                item.angle = angle;
            })
            return data;
            console.log(data)
        }
        //随机颜色
        PieChart.prototype.getRandomColor = function(){
            var r = Math.floor(Math.random()*256);
            var g = Math.floor(Math.random()*256);
            var b = Math.floor(Math.random()*256);
            return 'rgb('+r+','+g+','+b+')';
        }


        //设置数据
        var data = [
        {
            title:'15-20岁',
            num:6
        },
        {
            title:'20-25岁',
            num:30
        },
        {
            title:'25-30岁',
            num:10
        },
        {
            title:'30岁以上',
            num:8
        }

        ]
        var pieChart = new PieChart();
        pieChart.init(data)
    </script>
</body>
</html>